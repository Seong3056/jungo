{% extends 'base.html' %}
{% load static %}
{% load tz %}
{% load humanize %}
{% block content %}

<div class="chat-layout container">
  <aside class="listing-panel glass">
    <h3>{{ listing.title }}</h3>
    {% if listing.image %}
    <img src="{{ listing.image.url }}" alt="{{ listing.title }}" style="width:100%;border-radius:8px;object-fit:cover;max-height:420px;" />
    {% endif %}
    <p style="font-size:18px;font-weight:700;margin:12px 0 4px;">{{ listing.price|intcomma }} 원</p>
    <p style="color:var(--muted);margin:0 0 8px;">판매자: {{ listing.seller.username }}</p>
    <div style="margin-top:12px;">{{ listing.description|linebreaks }}</div>
  </aside>

  <section class="chat-column">
    <div class="chat-container glass">
      <h2 style="margin:0 0 12px;">{{ listing.title }} — {{ other_user.username }}님과의 대화</h2>
      <div class="chat-messages" id="chat-messages">
    {% for message in messages %}
      {% if message.sender == request.user %}
        <div class="message-row me">
          <div class="message me">
            {{ message.content }}
            <div class="timestamp">
              {% if message.timestamp|date:"Y-m-d" == now|date:"Y-m-d" %}
                {{ message.timestamp|date:"H:i" }}
              {% else %}
                {{ message.timestamp|date:"y.m.d H:i" }}
              {% endif %}
            </div>
          </div>
        </div>
      {% else %}
        <div class="message-row other">
          <div class="message other">
            {{ message.content }}
            <div class="timestamp">
              {% if message.timestamp|date:"Y-m-d" == now|date:"Y-m-d" %}
                {{ message.timestamp|date:"H:i" }}
              {% else %}
                {{ message.timestamp|date:"y.m.d H:i" }}
              {% endif %}
            </div>
          </div>
        </div>
      {% endif %}
    {% empty %}
      <p>아직 메시지가 없습니다.</p>
    {% endfor %}
    </div>

            <form method="POST" class="chat-form chat-form--spaced">
      {% csrf_token %}
      <textarea name="content" placeholder="메시지를 입력하세요" required></textarea>
      <div class="chat-form__actions"
           data-has-order="{% if order %}true{% else %}false{% endif %}"
           data-order-confirmed="{% if order and order.escrow_state == 'RELEASED' %}true{% else %}false{% endif %}"
           data-order-id="{% if order %}{{ order.id }}{% endif %}"
           data-order-state="{% if order %}{{ order.escrow_state }}{% endif %}"
           data-initial-code="{% if order and order.confirmation_code %}{{ order.confirmation_code }}{% endif %}"
           data-listing-id="{{ listing.id }}"
           data-buyer-id="{{ room.buyer.id }}"
           data-is-seller="{% if request.user == room.seller %}true{% else %}false{% endif %}"
           data-is-buyer="{% if request.user == room.buyer %}true{% else %}false{% endif %}">
        <button type="submit" class="btn chat-form__send">보내기</button>
        {% if request.user == room.buyer %}
        <button type="button"
                class="btn chat-form__purchase"
                data-listing-id="{{ listing.id }}"
                data-amount="{{ listing.price }}"
                {% if order %}disabled{% endif %}>
          {% if order %}
            {% if order.escrow_state == 'RELEASED' %}
              구매완료
            {% else %}
              구매요청됨
            {% endif %}
          {% else %}
            구매하기
          {% endif %}
        </button>
        {% endif %}
        {% if request.user == room.seller %}
        <button type="button"
                class="btn chat-form__confirm"
                {% if order %}data-order-id="{{ order.id }}"{% endif %}
                {% if not order or order.escrow_state == 'RELEASED' %}disabled{% endif %}>
          {% if order and order.escrow_state == 'RELEASED' %}
            구매확정 완료
          {% else %}
            구매확정
          {% endif %}
        </button>
        {% endif %}
      </div>
    </form>
    {% if request.user == room.buyer %}
    <div class="chat-purchase-code"
         data-empty-text="구매를 진행하면 수령 확인 코드를 받게 됩니다."
         data-pending-text="판매자의 구매확정을 기다리고 있습니다."
         data-complete-prefix="수령 확인 코드: "
         data-initial-code="{% if order and order.confirmation_code %}{{ order.confirmation_code }}{% endif %}"
         data-initial-state="{% if order %}{% if order.escrow_state == 'RELEASED' %}released{% else %}pending{% endif %}{% else %}none{% endif %}">
      {% if order %}
        {% if order.escrow_state == 'RELEASED' and order.confirmation_code %}
          수령 확인 코드: <span class="chat-purchase-code__value">{{ order.confirmation_code }}</span>
        {% else %}
          판매자의 구매확정을 기다리고 있습니다.
        {% endif %}
      {% else %}
        구매를 진행하면 수령 확인 코드를 받게 됩니다.
      {% endif %}
    </div>
    {% endif %}
</section>
</div>

{% endblock %}

{% block scripts %}
  {{ block.super }}
  <script src="{% static 'js/chat_room.js' %}" defer></script>
{% endblock %}
