{% extends 'base.html' %}
{% load static %}
{% load tz %}
{% load humanize %}
{% block content %}

<div class="chat-layout container">
  <aside class="listing-panel glass">
    <h3>{{ listing.title }}</h3>
    {% if listing.image %}
    <img src="{{ listing.image.url }}" alt="{{ listing.title }}" style="width:100%;border-radius:8px;object-fit:cover;max-height:420px;" />
    {% endif %}
    <p style="font-size:18px;font-weight:700;margin:12px 0 4px;">{{ listing.price|intcomma }} 원</p>
    <p style="color:var(--muted);margin:0 0 8px;">판매자: {{ listing.seller.username }}</p>
    <div style="margin-top:12px;">{{ listing.description|linebreaks }}</div>
  </aside>

  <section class="chat-column">
    <div class="chat-container glass">
      <h2 style="margin:0 0 12px;">{{ listing.title }} — {{ other_user.username }}님과의 대화</h2>
      <div class="chat-messages" id="chat-messages">
    {% for message in messages %}
      {% if message.sender == request.user %}
        <div class="message-row me">
          <div class="message me">
            {{ message.content }}
            <div class="timestamp">
              {% if message.timestamp|date:"Y-m-d" == now|date:"Y-m-d" %}
                {{ message.timestamp|date:"H:i" }}
              {% else %}
                {{ message.timestamp|date:"y.m.d H:i" }}
              {% endif %}
            </div>
          </div>
        </div>
      {% else %}
        <div class="message-row other">
          <div class="message other">
            {{ message.content }}
            <div class="timestamp">
              {% if message.timestamp|date:"Y-m-d" == now|date:"Y-m-d" %}
                {{ message.timestamp|date:"H:i" }}
              {% else %}
                {{ message.timestamp|date:"y.m.d H:i" }}
              {% endif %}
            </div>
          </div>
        </div>
      {% endif %}
    {% empty %}
      <p>아직 메시지가 없습니다.</p>
    {% endfor %}
    </div>

        <form method="POST" class="chat-form chat-form--spaced">
      {% csrf_token %}
      <textarea name="content" placeholder="메시지를 입력하세요" required></textarea>
      <div class="chat-form__actions">
        <button type="submit" class="btn chat-form__send">보내기</button>
        {% if request.user != listing.seller %}
        <button type="button"
                class="btn chat-form__purchase"
                data-listing-id="{{ listing.id }}"
                data-amount="{{ listing.price }}">
          구매하기
        </button>
        {% endif %}
      </div>
    </form>
  </section>
</div>
<script>
  (function(){
    const form = document.querySelector('.chat-form');
    const messagesEl = document.getElementById('chat-messages');
    if (!form || !messagesEl) return;

    const textarea = form.querySelector('textarea[name="content"]');
    if (!textarea) return;

    const csrfInput = form.querySelector('input[name="csrfmiddlewaretoken"]');
    const csrftoken = csrfInput ? csrfInput.value : '';
    const submitButton = form.querySelector('.chat-form__send');
    const purchaseBtn = form.querySelector('.chat-form__purchase');

    textarea.addEventListener('keydown', function(e){
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        if (typeof form.requestSubmit === 'function') {
          form.requestSubmit();
        } else if (submitButton) {
          submitButton.click();
        }
      }
    });

    function scrollToBottom(){
      messagesEl.scrollTop = messagesEl.scrollHeight;
    }

    function makeMessageNode(data){
      const row = document.createElement('div');
      row.className = 'message-row me';
      const msg = document.createElement('div');
      msg.className = 'message me';
      msg.innerHTML = `${data.content}<div class="timestamp">${data.timestamp}</div>`;
      row.appendChild(msg);
      return row;
    }

    form.addEventListener('submit', async function(e){
      e.preventDefault();
      const content = textarea.value.trim();
      if (!content) return;

      try{
        const resp = await fetch(window.location.href, {
          method: 'POST',
          headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'X-CSRFToken': csrftoken,
            'Accept': 'application/json',
            'Content-Type': 'application/x-www-form-urlencoded; charset=UTF-8'
          },
          body: new URLSearchParams({content})
        });

        if (resp.ok) {
          const data = await resp.json();
          const node = makeMessageNode(data);
          messagesEl.appendChild(node);
          textarea.value = '';
          scrollToBottom();
        } else {
          form.removeEventListener('submit', arguments.callee);
          form.submit();
        }
      } catch (err){
        console.error(err);
        form.removeEventListener('submit', arguments.callee);
        form.submit();
      }
    });

    if (purchaseBtn) {
      purchaseBtn.addEventListener('click', async function(){
        const listingId = purchaseBtn.dataset.listingId;
        const amount = purchaseBtn.dataset.amount;
        if (!listingId || !amount) return;

        const originalLabel = purchaseBtn.textContent.trim() || '구매하기';
        purchaseBtn.disabled = true;
        purchaseBtn.textContent = '구매 진행중...';

        try {
          const resp = await fetch('/api/orders/', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Accept': 'application/json',
              'X-Requested-With': 'XMLHttpRequest',
              'X-CSRFToken': csrftoken
            },
            body: JSON.stringify({
              listing: Number(listingId),
              amount: Number(amount)
            })
          });

          if (resp.ok) {
            alert('구매 요청이 접수되었습니다.');
          } else {
            let message = '구매 요청 처리 중 오류가 발생했습니다.';
            try {
              const data = await resp.json();
              if (data) {
                if (typeof data.detail === 'string') {
                  message = data.detail;
                } else {
                  const firstValue = Object.values(data)[0];
                  if (Array.isArray(firstValue) && firstValue.length) {
                    message = firstValue[0];
                  }
                }
              }
            } catch (_) {}
            alert(message);
          }
        } catch (error) {
          console.error(error);
          alert('구매 요청 처리 중 오류가 발생했습니다.');
        } finally {
          purchaseBtn.disabled = false;
          purchaseBtn.textContent = originalLabel;
        }
      });
    }

    scrollToBottom();
  })();
</script>
{% endblock %}
